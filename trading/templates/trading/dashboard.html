<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KiteMaster Algo Dashboard</title>
    
    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons (CDN) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* CRITICAL: Force Dark Theme immediately */
        html, body {
            background-color: #030712 !important; /* Tailwind gray-950 */
            color: #f3f4f6;
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 0;
            height: 100%;
        }
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1f2937; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        
        .hidden { display: none !important; }
        
        /* Utility classes in case Tailwind fails */
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .h-screen { height: 100vh; }
    </style>
</head>
<body class="min-h-screen flex flex-col text-gray-100 bg-gray-950">

    <!-- HEADER -->
    <header class="bg-gray-900 border-b border-gray-800 px-3 py-1 shadow-lg flex justify-between items-center sticky top-0 z-30 h-10 w-full">
        <div class="flex items-center gap-2">
           <div class="w-5 h-5 bg-blue-700 rounded flex items-center justify-center font-bold text-[9px] text-white shadow-lg">KM</div>
           <h1 class="text-xl font-bold tracking-tight text-gray-100 leading-none">Kite <span class="text-blue-500 font-light">Master</span></h1>
        </div>
        <div class="flex items-center gap-4 ml-auto">
            <!-- Data Heartbeat -->
            <div class="flex items-center gap-2 px-2 py-1 bg-gray-800 rounded border border-gray-700">
                <div id="data-dot" class="w-2 h-2 rounded-full bg-red-500"></div>
                <span id="data-text" class="text-[9px] font-bold uppercase text-red-400">Disconnected</span>
            </div>

            <div class="text-[10px] font-bold uppercase tracking-wider flex items-center gap-2 bg-gray-800 px-2 py-0.5 rounded border border-gray-700">
                <span class="text-gray-400">Total P&L:</span>
                <span id="total-pnl" class="text-sm text-gray-100">0.00</span>
            </div>
            
            <div class="flex items-center gap-3 text-[9px]">
               <button onclick="window.location.href='/api/kite/login/'" class="flex items-center gap-1 text-gray-300 hover:text-white bg-gray-800 hover:bg-gray-700 px-2 py-1 rounded border border-gray-600 transition-colors font-bold uppercase tracking-wide">
                  <i data-lucide="key" class="w-3 h-3"></i> Login Kite
               </button>
            </div>
        </div>
    </header>

    <!-- SETTINGS MODAL -->
    <div id="settings-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 backdrop-blur-sm hidden">
        <div class="bg-gray-800 border border-emerald-600 rounded-lg shadow-2xl w-[40rem] p-5 max-h-[90vh] flex flex-col" id="modal-container">
            <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-3 flex-shrink-0">
                <h3 id="modal-title" class="text-sm font-bold flex items-center gap-2 text-emerald-400">
                    <i data-lucide="settings" class="w-4 h-4"></i> Configuration
                </h3>
                <button onclick="closeSettings()" class="text-gray-400 hover:text-white transition-colors"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>
            
            <div class="flex-1 overflow-y-auto pr-2 custom-scrollbar">
                <!-- Engine Specific Config -->
                <div class="bg-gray-800 p-3 rounded-lg border border-gray-700 mb-4">
                    <h3 class="font-bold text-gray-200 text-xs uppercase tracking-wide mb-2">Strategy Risk Config</h3>
                    <!-- Form Fields -->
                    <div class="grid grid-cols-5 gap-2 mb-2">
                        <div><label class="block text-[9px] font-bold text-gray-400">Risk:Reward</label><input id="inp-rr" class="w-full bg-gray-900 border border-gray-600 rounded px-2 h-6 text-xs font-bold text-gray-100"></div>
                        <div><label class="block text-[9px] font-bold text-gray-400">Trailing SL</label><input id="inp-tsl" class="w-full bg-gray-900 border border-gray-600 rounded px-2 h-6 text-xs font-bold text-gray-100"></div>
                        <div><label class="block text-[9px] font-bold text-gray-400">Max Trades</label><input id="inp-max-trades" type="number" class="w-full bg-gray-900 border border-gray-600 rounded px-2 h-6 text-xs font-bold text-gray-100"></div>
                        <div><label class="block text-[9px] font-bold text-gray-400">Start</label><input id="inp-start" type="time" class="w-full bg-gray-900 border border-gray-600 rounded px-1 h-6 text-[10px] font-bold text-gray-100"></div>
                        <div><label class="block text-[9px] font-bold text-gray-400">End</label><input id="inp-end" type="time" class="w-full bg-gray-900 border border-gray-600 rounded px-1 h-6 text-[10px] font-bold text-gray-100"></div>
                    </div>
                    <!-- Tiered Risk -->
                    <div class="grid grid-cols-4 gap-2 mb-3 bg-gray-900/30 p-1.5 rounded border border-gray-700/50">
                        <div><label class="block text-[9px] font-bold text-blue-400">Entries/Stock</label><input id="inp-tps" type="number" class="w-full bg-gray-900 border border-blue-900 rounded px-2 h-6 text-xs font-bold text-blue-100"></div>
                        <div><label class="block text-[9px] font-bold text-gray-500">Risk (1st)</label><input id="inp-r1" type="number" class="w-full bg-gray-900 border border-gray-600 rounded px-2 h-6 text-xs font-bold text-gray-100"></div>
                        <div><label class="block text-[9px] font-bold text-gray-500">Risk (2nd)</label><input id="inp-r2" type="number" class="w-full bg-gray-900 border border-gray-600 rounded px-2 h-6 text-xs font-bold text-gray-100"></div>
                        <div><label class="block text-[9px] font-bold text-gray-500">Risk (3rd)</label><input id="inp-r3" type="number" class="w-full bg-gray-900 border border-gray-600 rounded px-2 h-6 text-xs font-bold text-gray-100"></div>
                    </div>
                    <!-- P&L -->
                    <div id="pnl-container" class="p-2 rounded border bg-gray-750 border-gray-700 flex items-center justify-between gap-3">
                        <div class="flex items-center gap-1.5 text-[10px] font-bold text-gray-300">Global P&L Exit</div>
                        <div class="flex items-center gap-2 flex-1">
                            <input id="inp-max-p" type="number" placeholder="Max Profit" class="bg-gray-800 border border-gray-600 rounded h-7 px-2 w-full text-xs font-bold text-green-400">
                            <input id="inp-max-l" type="number" placeholder="Max Loss" class="bg-gray-800 border border-gray-600 rounded h-7 px-2 w-full text-xs font-bold text-red-400">
                        </div>
                        <input type="checkbox" id="inp-pnl-enabled" class="w-4 h-4">
                    </div>
                </div>

                <div class="h-px bg-gray-700 my-4"></div>

                <!-- VOLUME 10 LEVELS -->
                <div class="flex items-center gap-2 mb-3">
                    <i data-lucide="sliders" class="w-3 h-3 text-gray-400"></i>
                    <h3 class="font-bold text-gray-200 text-xs uppercase tracking-wide">Volume SMA Criteria (10 Levels)</h3>
                </div>
                
                <div id="volume-levels-container" class="space-y-1">
                    <!-- Javascript will inject 10 rows here -->
                </div>
            </div>

            <div class="pt-4 mt-2 border-t border-gray-700 flex-shrink-0">
                <button onclick="saveSettings()" id="btn-save-settings" class="w-full text-white text-xs font-bold py-2.5 rounded transition-colors uppercase tracking-wider shadow-lg bg-emerald-600 hover:bg-emerald-700">
                    Save Configuration
                </button>
            </div>
        </div>
    </div>

    <!-- MAIN GRID -->
    <main class="p-4 grid grid-cols-2 gap-4 flex-1 items-start w-full">
        
        <!-- BULL SECTION -->
        <section class="flex flex-col bg-gray-900 p-3 rounded-xl border-t-4 border-emerald-600 shadow-xl min-h-full">
            <div class="flex items-center gap-2 mb-2 text-emerald-100 bg-emerald-900/20 p-1.5 rounded-lg border border-emerald-800/30">
                <i data-lucide="trending-up" class="w-4 h-4 text-emerald-400"></i>
                <h2 class="text-[10px] font-bold uppercase tracking-wider flex-1 flex items-center gap-2">
                    BULL P&L: <span id="bull-pnl" class="text-sm text-emerald-400">0.00</span>
                </h2>
                <!-- Bull Controls -->
                <button onclick="toggleEngine('bull')" id="btn-bull-toggle" class="w-8 h-4 rounded-full flex items-center bg-emerald-500 px-0.5 mx-2 transition-colors">
                    <div id="dot-bull-toggle" class="w-3 h-3 bg-white rounded-full shadow-md transform translate-x-4 transition-transform"></div>
                </button>
                <button onclick="openSettings('bull')" class="bg-gray-800 hover:bg-gray-700 text-gray-200 text-[9px] font-bold uppercase px-2 py-1 rounded border border-gray-600">Config</button>
                <button onclick="panicExit('bull')" class="bg-red-600 hover:bg-red-700 text-white text-[10px] font-bold uppercase px-1.5 py-1 rounded border border-red-500">EXIT ALL</button>
            </div>

            <!-- Bull Order Table -->
            <div class="bg-gray-800 p-3 rounded-lg shadow-md border border-gray-700 mb-3 min-h-[300px] flex flex-col">
                <div class="flex items-center justify-between mb-2 border-b border-gray-700 pb-2">
                    <h3 class="font-semibold text-gray-200 text-sm flex gap-2"><i data-lucide="activity" class="w-4 h-4 text-gray-400"></i> Executed Orders</h3>
                    <span id="bull-order-count" class="bg-gray-700 text-gray-300 text-[10px] px-2 rounded-full">0</span>
                </div>
                <div class="overflow-x-auto flex-1">
                    <table class="w-full text-xs text-left text-gray-300">
                        <thead class="bg-gray-900 text-gray-400 font-medium uppercase">
                            <tr><th class="px-2 py-2">Stock</th><th class="px-2 py-2">Entry</th><th class="px-2 py-2">Tgt/SL</th><th class="px-2 py-2">P&L</th><th class="px-2 py-2 text-right">Act</th></tr>
                        </thead>
                        <tbody id="bull-orders-tbody" class="divide-y divide-gray-700"></tbody>
                    </table>
                </div>
            </div>

            <!-- Bull Scanner -->
            <div class="bg-gray-800 p-3 rounded-lg shadow-md border border-gray-700 mb-3 min-h-[300px] flex flex-col">
                <div class="flex items-center justify-between mb-2 border-b border-gray-700 pb-2">
                    <h3 class="font-semibold text-gray-200 text-sm flex gap-2"><i data-lucide="target" class="w-4 h-4 text-gray-400"></i> Scanner</h3>
                    <span id="bull-scan-count" class="bg-gray-700 text-gray-300 text-[10px] px-2 rounded-full">0</span>
                </div>
                <div id="bull-scanner-list" class="space-y-1 flex-1 overflow-y-auto max-h-[300px] custom-scrollbar"></div>
            </div>
        </section>

        <!-- BEAR SECTION -->
        <section class="flex flex-col bg-gray-900 p-3 rounded-xl border-t-4 border-rose-600 shadow-xl min-h-full">
            <div class="flex items-center gap-2 mb-2 text-rose-100 bg-rose-900/20 p-1.5 rounded-lg border border-rose-800/30">
                <i data-lucide="trending-down" class="w-4 h-4 text-rose-400"></i>
                <h2 class="text-[10px] font-bold uppercase tracking-wider flex-1 flex items-center gap-2">
                    BEAR P&L: <span id="bear-pnl" class="text-sm text-rose-400">0.00</span>
                </h2>
                <!-- Bear Controls -->
                <button onclick="toggleEngine('bear')" id="btn-bear-toggle" class="w-8 h-4 rounded-full flex items-center bg-rose-500 px-0.5 mx-2 transition-colors">
                    <div id="dot-bear-toggle" class="w-3 h-3 bg-white rounded-full shadow-md transform translate-x-4 transition-transform"></div>
                </button>
                <button onclick="openSettings('bear')" class="bg-gray-800 hover:bg-gray-700 text-gray-200 text-[9px] font-bold uppercase px-2 py-1 rounded border border-gray-600">Config</button>
                <button onclick="panicExit('bear')" class="bg-red-600 hover:bg-red-700 text-white text-[10px] font-bold uppercase px-1.5 py-1 rounded border border-red-500">EXIT ALL</button>
            </div>

            <!-- Bear Order Table -->
            <div class="bg-gray-800 p-3 rounded-lg shadow-md border border-gray-700 mb-3 min-h-[300px] flex flex-col">
                <div class="flex items-center justify-between mb-2 border-b border-gray-700 pb-2">
                    <h3 class="font-semibold text-gray-200 text-sm flex gap-2"><i data-lucide="activity" class="w-4 h-4 text-gray-400"></i> Executed Orders</h3>
                    <span id="bear-order-count" class="bg-gray-700 text-gray-300 text-[10px] px-2 rounded-full">0</span>
                </div>
                <div class="overflow-x-auto flex-1">
                    <table class="w-full text-xs text-left text-gray-300">
                        <thead class="bg-gray-900 text-gray-400 font-medium uppercase">
                            <tr><th class="px-2 py-2">Stock</th><th class="px-2 py-2">Entry</th><th class="px-2 py-2">Tgt/SL</th><th class="px-2 py-2">P&L</th><th class="px-2 py-2 text-right">Act</th></tr>
                        </thead>
                        <tbody id="bear-orders-tbody" class="divide-y divide-gray-700"></tbody>
                    </table>
                </div>
            </div>

            <!-- Bear Scanner -->
            <div class="bg-gray-800 p-3 rounded-lg shadow-md border border-gray-700 mb-3 min-h-[300px] flex flex-col">
                <div class="flex items-center justify-between mb-2 border-b border-gray-700 pb-2">
                    <h3 class="font-semibold text-gray-200 text-sm flex gap-2"><i data-lucide="target" class="w-4 h-4 text-gray-400"></i> Scanner</h3>
                    <span id="bear-scan-count" class="bg-gray-700 text-gray-300 text-[10px] px-2 rounded-full">0</span>
                </div>
                <div id="bear-scanner-list" class="space-y-1 flex-1 overflow-y-auto max-h-[300px] custom-scrollbar"></div>
            </div>
        </section>
    </main>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // Initialize Icons
        if(window.lucide) lucide.createIcons();

        // State
        let activeEngine = null; // 'bull' or 'bear'
        let engineStatus = { bull: true, bear: true };
        let volumeCriteria = [];
        let blacklisted = new Set();

        // --- API HELPERS (WITH MOCK FALLBACK) ---
        async function fetchAPI(url, options = {}) {
            try {
                // Try real fetch first
                const res = await fetch(url, options);
                if(!res.ok) throw new Error(res.statusText);
                return await res.json();
            } catch (e) { 
                console.warn("API Error, using mock data for preview:", e); 
                return getMockData(url); 
            }
        }

        async function postAPI(action, payload) {
            console.log(`[ACTION] ${action}`, payload);
            return await fetchAPI('/api/control/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action, ...payload })
            });
        }

        // --- MOCK DATA FOR PREVIEW MODE ---
        function getMockData(url) {
            if(url.includes('/api/stats')) {
                return {
                    pnl: { total: 1250.50, bull: 1500.00, bear: -249.50 },
                    engine_status: { bull: engineStatus.bull?"1":"0", bear: engineStatus.bear?"1":"0" },
                    data_connected: true
                };
            }
            if(url.includes('/api/orders')) {
                return {
                    bull: [{id:1, symbol:'RELIANCE', entry:2450, target:2500, sl:2430, status:'OPEN', pnl:1500, quantity:50}],
                    bear: [{id:2, symbol:'ADANIENT', entry:3200, target:3150, sl:3220, status:'CLOSED', pnl:-249.50, quantity:25}]
                };
            }
            if(url.includes('/api/scanner')) {
                return {
                    bull: [{id:101, symbol:'INFY', signal_strength:'Breakout', price:1420, time:'09:30', volume_price:'12Cr', candle_size:'0.5%', status:'PENDING'}],
                    bear: []
                };
            }
            if(url.includes('/settings')) {
                return {
                    risk_reward: '1:2', trailing_sl: '1:1', total_trades: 5,
                    start_time: '09:15', end_time: '15:15', trades_per_stock: 2,
                    risk_trade_1: 2000, risk_trade_2: 1500, risk_trade_3: 1000,
                    max_profit: 5000, max_loss: 2000, pnl_exit_enabled: false,
                    volume_criteria: Array.from({length:10}, (_,i)=>({min_vol_price_cr:(i+1)*5, sma_multiplier:2.0, min_sma_avg:50000}))
                };
            }
            return {};
        }

        // --- DASHBOARD UPDATES ---
        async function updateDashboard() {
            // 1. Stats & P&L
            const stats = await fetchAPI('/api/stats/');
            if (stats) {
                // Update P&L Texts
                const totalPnl = stats.pnl ? stats.pnl.total : 0;
                document.getElementById('total-pnl').innerText = (totalPnl > 0 ? '+' : '') + totalPnl.toFixed(2);
                document.getElementById('total-pnl').className = `text-sm ${totalPnl >= 0 ? 'text-emerald-400' : 'text-red-400'}`;
                
                if(stats.pnl) {
                    document.getElementById('bull-pnl').innerText = (stats.pnl.bull > 0 ? '+' : '') + stats.pnl.bull.toFixed(2);
                    document.getElementById('bear-pnl').innerText = (stats.pnl.bear > 0 ? '+' : '') + stats.pnl.bear.toFixed(2);
                }

                // Update Heartbeat Dot
                const dot = document.getElementById('data-dot');
                const txt = document.getElementById('data-text');
                if (stats.data_connected) {
                    dot.className = "w-2 h-2 rounded-full bg-emerald-500 animate-pulse";
                    txt.className = "text-[9px] font-bold uppercase text-emerald-400";
                    txt.innerText = "Data Live";
                } else {
                    dot.className = "w-2 h-2 rounded-full bg-red-500";
                    txt.className = "text-[9px] font-bold uppercase text-red-400";
                    txt.innerText = "Disconnected";
                }

                // Update Engine Switch Visuals
                if(stats.engine_status) {
                    updateToggleVisual('bull', stats.engine_status.bull === "1");
                    updateToggleVisual('bear', stats.engine_status.bear === "1");
                }
            }

            // 2. Orders
            const orders = await fetchAPI('/api/orders/');
            if (orders) {
                renderOrders(orders.bull, 'bull-orders-tbody', 'bull-order-count');
                renderOrders(orders.bear, 'bear-orders-tbody', 'bear-order-count');
            }

            // 3. Scanner
            const scanner = await fetchAPI('/api/scanner/');
            if (scanner) {
                renderScanner(scanner.bull, 'bull-scanner-list', 'bull-scan-count');
                renderScanner(scanner.bear, 'bear-scanner-list', 'bear-scan-count');
            }
        }

        // --- RENDERING ---
        function renderOrders(list, bodyId, countId) {
            const tbody = document.getElementById(bodyId);
            document.getElementById(countId).innerText = list ? list.length : 0;
            if(!list || list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500 italic">No executed orders</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            list.forEach(order => {
                const isBanned = blacklisted.has(order.symbol);
                const row = document.createElement('tr');
                row.className = `hover:bg-gray-750 transition-colors ${isBanned ? 'opacity-50' : ''}`;
                
                row.innerHTML = `
                    <td class="px-2 py-3">
                        <div class="font-bold text-sm ${isBanned ? 'line-through text-red-400' : 'text-gray-100'}">
                            ${order.symbol} <span class="text-[10px] font-normal text-gray-500">(${order.quantity})</span>
                        </div>
                        <button onclick="window.open('https://in.tradingview.com/chart/?symbol=NSE:${order.symbol}')" class="text-[10px] text-blue-400 hover:text-blue-300 flex items-center gap-0.5 mt-0.5">Chart ↗</button>
                    </td>
                    <td class="px-2 py-3 font-mono text-gray-300">${order.entry.toFixed(2)}</td>
                    <td class="px-2 py-3"><div class="text-green-400 font-medium">${order.target.toFixed(2)}</div><div class="text-red-400 font-medium">${order.sl.toFixed(2)}</div></td>
                    <td class="px-2 py-3">
                        <span class="font-mono font-bold ${order.pnl >= 0 ? 'text-green-400' : 'text-red-400'}">${order.pnl > 0 ? '+' : ''}${order.pnl.toFixed(2)}</span>
                        <div class="mt-0.5 text-[9px] uppercase font-bold tracking-wider ${order.status === 'OPEN' ? 'text-blue-300' : 'text-gray-500'}">${order.status}</div>
                    </td>
                    <td class="px-2 py-3 text-right">
                        <div class="flex justify-end gap-2">
                            <button onclick="toggleBan('${order.symbol}')" class="p-1.5 rounded border transition-colors ${isBanned ? 'bg-red-900/20 border-red-800 text-red-500' : 'bg-gray-700 border-gray-600 text-gray-400'}">Ban</button>
                            ${order.status === 'OPEN' ? `<button onclick="forceExit('${order.symbol}')" class="bg-red-900/80 text-red-100 hover:bg-red-700 transition-colors px-2 py-1 rounded border border-red-700 text-[10px] font-bold uppercase">Exit</button>` : ''}
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderScanner(list, divId, countId) {
            const container = document.getElementById(divId);
            document.getElementById(countId).innerText = list ? list.length : 0;
            if(!list || list.length === 0) {
                container.innerHTML = '<div class="text-center py-4 text-gray-500 italic text-xs">No signals generated today</div>';
                return;
            }

            container.innerHTML = '';
            list.forEach(item => {
                const isBanned = blacklisted.has(item.symbol);
                const statusColor = item.status === 'PENDING' ? 'text-blue-400' : (item.status === 'EXPIRED' ? 'text-gray-500' : 'text-red-400');
                
                const div = document.createElement('div');
                div.className = `flex items-center gap-2 p-2 rounded bg-gray-750 border border-gray-700 transition-all ${isBanned ? 'opacity-50 grayscale' : 'hover:border-blue-500/50 hover:bg-gray-700'}`;
                div.innerHTML = `
                    <div class="font-bold text-xs w-20 flex items-center gap-1 ${isBanned ? 'line-through text-gray-500' : 'text-gray-200'}">
                        ${item.symbol}
                        <button onclick="window.open('https://in.tradingview.com/chart/?symbol=NSE:${item.symbol}')" class="text-gray-500 hover:text-blue-400">↗</button>
                    </div>
                    <div class="text-[10px] text-gray-400 font-mono w-14">${item.time}</div>
                    <div class="text-[9px] font-bold uppercase w-20 truncate ${statusColor}">${item.status}</div>
                    <div class="flex items-center gap-1 text-[10px]"><span class="text-gray-500">VP:</span><span class="font-extrabold text-amber-300">${item.volume_price}</span></div>
                    <div class="flex items-center gap-1 text-[10px]"><span class="text-gray-500">Sz:</span><span class="font-extrabold text-cyan-300">${item.candle_size}</span></div>
                    <div class="ml-auto font-mono font-bold text-gray-300 text-xs">₹${item.price}</div>
                    <button onclick="toggleBan('${item.symbol}')" class="p-1 rounded-full flex-shrink-0 transition-colors ml-2 ${isBanned ? 'text-red-500 bg-red-900/20' : 'text-gray-500 hover:text-red-400 hover:bg-gray-600'}">Ø</button>
                `;
                container.appendChild(div);
            });
        }

        // --- CONTROLS ---
        function toggleBan(symbol) {
            const isBanned = blacklisted.has(symbol);
            if(isBanned) blacklisted.delete(symbol); else blacklisted.add(symbol);
            postAPI(isBanned ? 'unban_symbol' : 'ban_symbol', { symbol });
            updateDashboard(); 
        }

        function forceExit(symbol) {
            if(confirm(`Force EXIT ${symbol}?`)) {
                postAPI('exit_trade', { symbol });
            }
        }

        function panicExit(side) {
            if(confirm(`EXIT ALL ${side.toUpperCase()} TRADES?`)) {
                postAPI('panic_exit', { side });
            }
        }

        function toggleEngine(side, forceState = null) {
            const newState = forceState !== null ? forceState : !engineStatus[side];
            engineStatus[side] = newState;
            updateToggleVisual(side, newState);
            postAPI('toggle_engine', { side, enabled: newState });
        }

        function updateToggleVisual(side, enabled) {
            engineStatus[side] = enabled;
            const btn = document.getElementById(`btn-${side}-toggle`);
            const dot = document.getElementById(`dot-${side}-toggle`);
            const color = side === 'bull' ? 'bg-emerald-500' : 'bg-rose-500';
            
            if(enabled) {
                btn.className = `w-8 h-4 rounded-full flex items-center px-0.5 mx-2 transition-colors ${color}`;
                dot.className = `w-3 h-3 bg-white rounded-full shadow-md transform translate-x-4 transition-transform`;
            } else {
                btn.className = `w-8 h-4 rounded-full flex items-center px-0.5 mx-2 transition-colors bg-gray-600`;
                dot.className = `w-3 h-3 bg-white rounded-full shadow-md transform translate-x-0 transition-transform`;
            }
        }

        // --- SETTINGS MODAL ---
        async function openSettings(side) {
            activeEngine = side;
            const modal = document.getElementById('settings-modal');
            const title = document.getElementById('modal-title');
            const color = side === 'bull' ? 'text-emerald-400' : 'text-rose-400';
            const border = side === 'bull' ? 'border-emerald-600' : 'border-rose-600';
            const btn = document.getElementById('btn-save-settings');
            
            // Style
            title.className = `text-sm font-bold flex items-center gap-2 ${color}`;
            document.getElementById('modal-container').className = `bg-gray-800 border ${border} rounded-lg shadow-2xl w-[40rem] p-5 max-h-[90vh] flex flex-col`;
            btn.className = `w-full text-white text-xs font-bold py-2.5 rounded transition-colors uppercase tracking-wider shadow-lg bg-${side==='bull'?'emerald':'rose'}-600 hover:bg-${side==='bull'?'emerald':'rose'}-700`;
            title.innerHTML = `<i data-lucide="settings" class="w-4 h-4"></i> ${side.toUpperCase()} Configuration`;
            if(window.lucide) lucide.createIcons();

            // Load Data
            const engineData = await fetchAPI(`/api/settings/engine/${side}/`);
            // Global data is now part of engineData return
            
            // Populate Inputs
            document.getElementById('inp-rr').value = engineData.risk_reward;
            document.getElementById('inp-tsl').value = engineData.trailing_sl;
            document.getElementById('inp-max-trades').value = engineData.total_trades;
            document.getElementById('inp-start').value = engineData.start_time;
            document.getElementById('inp-end').value = engineData.end_time;
            document.getElementById('inp-tps').value = engineData.trades_per_stock;
            document.getElementById('inp-r1').value = engineData.risk_trade_1;
            document.getElementById('inp-r2').value = engineData.risk_trade_2;
            document.getElementById('inp-r3').value = engineData.risk_trade_3;
            document.getElementById('inp-max-p').value = engineData.max_profit;
            document.getElementById('inp-max-l').value = engineData.max_loss;
            document.getElementById('inp-pnl-enabled').checked = engineData.pnl_exit_enabled;

            // Render Volume Levels
            renderVolumeInputs(engineData.volume_criteria || []);

            modal.classList.remove('hidden');
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.add('hidden');
            activeEngine = null;
        }

        function renderVolumeInputs(criteria) {
            const container = document.getElementById('volume-levels-container');
            container.innerHTML = '';
            
            const rows = Array.from({length: 10}, (_, i) => criteria[i] || {
                min_vol_price_cr: (i+1)*5, sma_multiplier: 2.0, min_sma_avg: 50000
            });

            rows.forEach((c, i) => {
                const div = document.createElement('div');
                div.className = "flex items-center gap-2 bg-gray-900/50 p-2 rounded border border-gray-700 text-[10px]";
                div.innerHTML = `
                    <div class="font-bold text-gray-400 w-8">Lvl ${i+1}</div>
                    <div class="flex-1">
                        <label class="block text-gray-500 uppercase text-[8px] mb-0.5">Min VP (Cr)</label>
                        <input type="number" class="vol-inp-vp bg-gray-800 border border-gray-600 rounded px-1 py-0.5 w-full text-amber-400 font-bold" value="${c.min_vol_price_cr}">
                    </div>
                    <div class="text-gray-600 font-bold px-1">&</div>
                    <div class="flex-1">
                        <label class="block text-gray-500 uppercase text-[8px] mb-0.5">SMA Mult</label>
                        <input type="number" class="vol-inp-sma bg-gray-800 border border-gray-600 rounded px-1 py-0.5 w-full text-cyan-400 font-bold" value="${c.sma_multiplier}">
                    </div>
                    <div class="text-gray-600 font-bold px-1">&</div>
                    <div class="flex-1">
                        <label class="block text-gray-500 uppercase text-[8px] mb-0.5">Min Avg Vol</label>
                        <input type="number" class="vol-inp-avg bg-gray-800 border border-gray-600 rounded px-1 py-0.5 w-full text-emerald-400 font-bold" value="${c.min_sma_avg}">
                    </div>
                `;
                container.appendChild(div);
            });
        }

        async function saveSettings() {
            if(!activeEngine) return;

            const vps = document.querySelectorAll('.vol-inp-vp');
            const smas = document.querySelectorAll('.vol-inp-sma');
            const avgs = document.querySelectorAll('.vol-inp-avg');
            const volCriteria = [];
            
            vps.forEach((_, i) => {
                volCriteria.push({
                    min_vol_price_cr: vps[i].value,
                    sma_multiplier: smas[i].value,
                    min_sma_avg: avgs[i].value
                });
            });

            const enginePayload = {
                risk_reward: document.getElementById('inp-rr').value,
                trailing_sl: document.getElementById('inp-tsl').value,
                total_trades: document.getElementById('inp-max-trades').value,
                start_time: document.getElementById('inp-start').value,
                end_time: document.getElementById('inp-end').value,
                trades_per_stock: document.getElementById('inp-tps').value,
                risk_trade_1: document.getElementById('inp-r1').value,
                risk_trade_2: document.getElementById('inp-r2').value,
                risk_trade_3: document.getElementById('inp-r3').value,
                max_profit: document.getElementById('inp-max-p').value,
                max_loss: document.getElementById('inp-max-l').value,
                pnl_exit_enabled: document.getElementById('inp-pnl-enabled').checked,
                volume_criteria: volCriteria 
            };

            await fetch(`/api/settings/engine/${activeEngine}/`, {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify(enginePayload)
            });

            closeSettings();
            alert("Settings Saved!");
        }

        // Initialize
        setInterval(updateDashboard, 1000); 
        updateDashboard(); 

    </script>
</body>
</html>