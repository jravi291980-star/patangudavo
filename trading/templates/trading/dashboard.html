<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KiteMaster Algo Dashboard</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (Compiles JSX in browser) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons (Vanilla JS version) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Custom scrollbar for a pro look */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        body { background-color: #030712; } /* Darker than gray-950 */
        
        /* Toast Animation */
        @keyframes slideIn {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .toast-enter { animation: slideIn 0.3s ease-out forwards; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- SETUP GLOBALS ---
        const { useState, useEffect, useCallback } = React;
        const API_URL = "/api"; 

        // --- ICON WRAPPER COMPONENT ---
        const Icon = ({ name, size = 16, className = "" }) => {
            useEffect(() => {
                lucide.createIcons();
            }, []);
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };

        const Settings = (p) => <Icon name="settings" {...p} />;
        const Activity = (p) => <Icon name="activity" {...p} />;
        const Target = (p) => <Icon name="target" {...p} />;
        const TrendingUp = (p) => <Icon name="trending-up" {...p} />;
        const TrendingDown = (p) => <Icon name="trending-down" {...p} />;
        const ExternalLink = (p) => <Icon name="external-link" {...p} />;
        const Ban = (p) => <Icon name="ban" {...p} />;
        const Power = (p) => <Icon name="power" {...p} />;
        const ShieldAlert = (p) => <Icon name="shield-alert" {...p} />;
        const DollarSign = (p) => <Icon name="dollar-sign" {...p} />;
        const BarChart2 = (p) => <Icon name="bar-chart-2" {...p} />;
        const X = (p) => <Icon name="x" {...p} />;
        const Info = (p) => <Icon name="info" {...p} />;
        const Key = (p) => <Icon name="key" {...p} />;
        const CheckCircle = (p) => <Icon name="check-circle" {...p} />;

        // --- TOAST NOTIFICATION COMPONENT ---
        const Toast = ({ message, type, onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 3000);
                return () => clearTimeout(timer);
            }, [onClose]);

            const bgClass = type === 'error' ? 'bg-red-600' : 'bg-emerald-600';
            
            return (
                <div className={`fixed bottom-5 right-5 ${bgClass} text-white px-4 py-3 rounded shadow-lg z-50 flex items-center gap-2 toast-enter`}>
                    {type === 'error' ? <ShieldAlert size={16}/> : <CheckCircle size={16}/>}
                    <span className="text-xs font-bold">{message}</span>
                </div>
            );
        };

        // --- MAIN DASHBOARD COMPONENT ---
        const Dashboard = () => {
            // --- STATE ---
            const [blacklistedStocks, setBlacklistedStocks] = useState(new Set());
            const [isGlobalSettingsOpen, setIsGlobalSettingsOpen] = useState(false);
            const [isCredentialsOpen, setIsCredentialsOpen] = useState(false);
            const [isAuthPending, setIsAuthPending] = useState(false);
            const [isConnected, setIsConnected] = useState(false);
            const [toast, setToast] = useState(null); // { message, type }
            
            // Real-time Data
            const [pnlData, setPnlData] = useState({ bull: 0, bear: 0, total: 0 });
            const [engineStatus, setEngineStatus] = useState({ bull: '0', bear: '0' });
            
            const [credentials, setCredentials] = useState({
                apiKey: '',
                apiSecret: '',
                accessToken: ''
            });

            const [globalSettings, setGlobalSettings] = useState({
                volume_criteria: [
                    { id: 1, min_vol_price_cr: 5, sma_multiplier: 3.0 },
                    { id: 2, min_vol_price_cr: 10, sma_multiplier: 2.0 },
                    { id: 3, min_vol_price_cr: 25, sma_multiplier: 1.5 },
                ]
            });

            const [bullSettings, setBullSettings] = useState({
                risk_reward: "1:2", trailing_sl: "1:1", total_trades: 5, trades_per_stock: 3, 
                risk_trade_1: 2000, risk_trade_2: 1500, risk_trade_3: 1000,
                pnl_exit_enabled: false, max_profit: 5000, max_loss: 2000,
            });

            const [bearSettings, setBearSettings] = useState({
                risk_reward: "1:2", trailing_sl: "1:1", total_trades: 5, trades_per_stock: 3,
                risk_trade_1: 2000, risk_trade_2: 1500, risk_trade_3: 1000,
                pnl_exit_enabled: false, max_profit: 5000, max_loss: 2000,
            });

            const [bullOrders, setBullOrders] = useState([]);
            const [bearOrders, setBearOrders] = useState([]);
            const [bullScanner, setBullScanner] = useState([]);
            const [bearScanner, setBearScanner] = useState([]);

            // --- HELPER FUNCTIONS ---
            const showToast = (msg, type = 'success') => setToast({ message: msg, type });

            // --- API INTERACTION ---
            const apiCall = async (endpoint, method = 'GET', body = null) => {
                try {
                    const options = {
                        method,
                        headers: { 'Content-Type': 'application/json' },
                    };
                    if (body) options.body = JSON.stringify(body);
                    const res = await fetch(endpoint, options);
                    const data = await res.json();
                    if (!res.ok) throw new Error(data.message || data.error || 'Request failed');
                    return data;
                } catch (err) {
                    console.error(`API Error (${endpoint}):`, err);
                    showToast(err.message, 'error');
                    return null;
                }
            };

            // --- DATA LOADING ---
            const fetchAllData = useCallback(async () => {
                // 1. Stats & PnL
                const stats = await apiCall(`${API_URL}/stats/`);
                if (stats) {
                    setPnlData(stats.pnl);
                    setEngineStatus(stats.engine_status);
                }

                // 2. Orders
                const orders = await apiCall(`${API_URL}/orders/`);
                if (orders) {
                    setBullOrders(orders.bull);
                    setBearOrders(orders.bear);
                }

                // 3. Scanner
                const scan = await apiCall(`${API_URL}/scanner/`);
                if (scan) {
                    setBullScanner(scan.bull);
                    setBearScanner(scan.bear);
                }
            }, []);

            const loadSettings = useCallback(async () => {
                // 1. Global Settings (API Keys & Vol Criteria)
                const global = await apiCall(`${API_URL}/settings/global/`);
                if (global) {
                    setCredentials({ 
                        apiKey: global.api_key || '', 
                        apiSecret: global.api_secret || '',
                        accessToken: '' 
                    });
                    if (global.volume_criteria) {
                        setGlobalSettings(prev => ({ ...prev, volume_criteria: global.volume_criteria }));
                    }
                    if (global.api_key && global.api_secret) setIsConnected(true); // Basic check
                }

                // 2. Engine Settings
                const bull = await apiCall(`${API_URL}/settings/engine/bull/`);
                if (bull) setBullSettings(prev => ({...prev, ...bull}));

                const bear = await apiCall(`${API_URL}/settings/engine/bear/`);
                if (bear) setBearSettings(prev => ({...prev, ...bear}));

            }, []);

            // Initial Load
            useEffect(() => {
                loadSettings();
                fetchAllData();
                const interval = setInterval(fetchAllData, 3000); // Poll every 3s
                setTimeout(() => lucide.createIcons(), 100);
                return () => clearInterval(interval);
            }, [fetchAllData, loadSettings]);

            // Re-render icons on updates
            useEffect(() => {
                lucide.createIcons();
            });

            // --- ACTIONS ---
            const initiateKiteLogin = () => { window.location.href = `${API_URL}/kite/login/`; };

            // SAVE CREDENTIALS
            const saveCredentials = async () => {
                const payload = { api_key: credentials.apiKey, api_secret: credentials.apiSecret };
                const res = await apiCall(`${API_URL}/settings/global/`, 'POST', payload);
                if (res) {
                    showToast("Credentials Saved Successfully");
                    setIsCredentialsOpen(false);
                }
            };

            // SAVE GLOBAL CRITERIA (Volume/SMA)
            const saveGlobalCriteria = async () => {
                const payload = { volume_criteria: globalSettings.volume_criteria };
                const res = await apiCall(`${API_URL}/settings/global/`, 'POST', payload);
                if (res) {
                    showToast("Global Criteria Updated");
                    setIsGlobalSettingsOpen(false);
                }
            };

            // UPDATE STATE FOR GLOBAL SETTINGS
            const updateGlobalSetting = (index, field, value) => {
                const newCriteria = [...globalSettings.volume_criteria];
                newCriteria[index][field] = parseFloat(value);
                setGlobalSettings({ ...globalSettings, volume_criteria: newCriteria });
            };

            // TOGGLE ENGINE
            const toggleEngine = async (side, enabled) => {
                // Optimistic Update
                setEngineStatus(prev => ({ ...prev, [side]: enabled ? '1' : '0' }));
                
                const res = await apiCall(`${API_URL}/control/`, 'POST', {
                    action: 'toggle_engine',
                    side: side,
                    enabled: enabled
                });
                
                if (res) showToast(`${side.toUpperCase()} Engine ${enabled ? 'Started' : 'Stopped'}`);
                else setEngineStatus(prev => ({ ...prev, [side]: !enabled ? '1' : '0' })); // Revert on fail
            };

            // UPDATE ENGINE SETTINGS (Risk, Max Profit etc)
            const handleEngineUpdate = async (side) => {
                const settings = side === 'bull' ? bullSettings : bearSettings;
                const res = await apiCall(`${API_URL}/settings/engine/${side}/`, 'POST', settings);
                if (res) showToast(`${side.toUpperCase()} Settings Saved`);
            };

            // PANIC EXIT
            const panicExit = async (side) => {
                if(window.confirm(`⚠️ CRITICAL: PANIC EXIT ${side.toUpperCase()}? This will close all open positions immediately.`)) {
                    const res = await apiCall(`${API_URL}/control/`, 'POST', { action: 'panic_exit', side });
                    if(res) showToast(`Panic Signal Sent to ${side.toUpperCase()}`);
                }
            };

            const toggleStopStock = async (symbol) => {
                // Assuming ban_symbol API exists or local logic
                // Here simply adding to blacklist locally, API would be better
                const isBanned = blacklistedStocks.has(symbol);
                const action = isBanned ? 'unban_symbol' : 'ban_symbol';
                
                const res = await apiCall(`${API_URL}/control/`, 'POST', { action, symbol });
                
                if (res) {
                    const newSet = new Set(blacklistedStocks);
                    if (isBanned) newSet.delete(symbol);
                    else newSet.add(symbol);
                    setBlacklistedStocks(newSet);
                    showToast(`${symbol} ${isBanned ? 'Unbanned' : 'Banned'}`);
                }
            };

            const openChart = (symbol) => {
                window.open(`https://in.tradingview.com/chart/?symbol=NSE:${symbol}`, '_blank');
            };

            // --- DERIVED STATE ---
            const totalGlobalPnL = pnlData.total || (pnlData.bull + pnlData.bear);
            
            const getSentimentStats = () => {
                const bullCount = bullScanner.length;
                const bearCount = bearScanner.length;
                const total = bullCount + bearCount;
                if (total === 0) return { percentage: 0, isBullish: true, bullCount: 0, bearCount: 0 };
                const percentage = Math.round(((bullCount - bearCount) / total) * 100);
                return { percentage, isBullish: percentage >= 0, bullCount, bearCount };
            };
            const sentiment = getSentimentStats();

            // --- SUB-COMPONENTS ---
            const EngineSettings = ({ settings, setSettings, side }) => {
                const engineEnabled = engineStatus[side] === '1';
                return (
                <div className="bg-gray-800 p-2 rounded-lg shadow-md border border-gray-700 mb-2">
                    <div className="flex items-center justify-between mb-1.5 border-b border-gray-700 pb-1">
                    <div className="flex items-center gap-1.5">
                        <Settings size={14} className="text-gray-400" />
                        <h3 className="font-bold text-gray-200 text-[10px]">Engine Config</h3>
                    </div>
                    <div className="flex items-center gap-2">
                        <span className={`text-[10px] font-bold uppercase ${engineEnabled ? 'text-emerald-400' : 'text-rose-400'}`}>{engineEnabled ? 'Running' : 'Stopped'}</span>
                        <button 
                            onClick={() => toggleEngine(side, !engineEnabled)} 
                            className={`w-5 h-2.5 rounded-full flex items-center transition-colors px-0.5 ${engineEnabled ? (side === 'bull' ? 'bg-emerald-500' : 'bg-rose-500') : 'bg-gray-600'}`}
                        >
                            <div className={`w-1.5 h-1.5 bg-white rounded-full shadow-md transform transition-transform ${engineEnabled ? 'translate-x-2.5' : 'translate-x-0'}`}></div>
                        </button>
                    </div>
                    </div>
                    
                    <div className="grid grid-cols-4 gap-1.5 mb-2">
                    <div>
                        <label className="block text-gray-300 mb-0 whitespace-nowrap text-[10px] font-bold text-left">Risk:Rew</label>
                        <input type="text" value={settings.risk_reward} onChange={(e) => setSettings({...settings, risk_reward: e.target.value})} className="w-full border border-gray-600 rounded px-1 py-0 h-5 text-[10px] font-bold focus:outline-none focus:border-blue-500 bg-gray-700 text-gray-100" />
                    </div>
                    <div>
                        <label className="block text-gray-300 mb-0 whitespace-nowrap text-[10px] font-bold text-left">Trail SL</label>
                        <input type="text" value={settings.trailing_sl} onChange={(e) => setSettings({...settings, trailing_sl: e.target.value})} className="w-full border border-gray-600 rounded px-1 py-0 h-5 text-[10px] font-bold focus:outline-none focus:border-blue-500 bg-gray-700 text-gray-100" />
                    </div>
                    <div>
                        <label className="block text-gray-300 mb-0 whitespace-nowrap text-[10px] font-bold text-left">Max Trds</label>
                        <input type="number" value={settings.total_trades} onChange={(e) => setSettings({...settings, total_trades: e.target.value})} className="w-full border border-gray-600 rounded px-1 py-0 h-5 text-[10px] font-bold focus:outline-none focus:border-blue-500 bg-gray-700 text-gray-100" />
                    </div>
                    <div>
                        <label className="block text-blue-300 mb-0 whitespace-nowrap text-[10px] font-bold text-left">Ent/Stk</label>
                        <input type="number" value={settings.trades_per_stock} onChange={(e) => setSettings({...settings, trades_per_stock: e.target.value})} className="w-full border border-blue-900 rounded px-1 py-0 h-5 text-[10px] font-bold focus:outline-none focus:border-blue-500 bg-gray-700 text-blue-100" />
                    </div>
                    </div>

                    <div className="mb-2 bg-gray-750 p-1 rounded border border-gray-600">
                        <div className="grid grid-cols-3 gap-1.5">
                        {[1, 2, 3].map(i => (
                            <div key={i} className="flex items-center border border-gray-600 rounded bg-gray-800 h-5 px-1.5">
                            <span className="text-gray-400 text-[13px] font-bold mr-1.5 flex-shrink-0">{i === 1 ? '1st' : i === 2 ? '2nd' : '3rd'}</span>
                            <input type="number" value={settings[`risk_trade_${i}`]} onChange={(e) => setSettings({...settings, [`risk_trade_${i}`]: parseFloat(e.target.value)})} className="bg-transparent w-full text-[13px] font-bold text-gray-100 focus:outline-none" />
                            </div>
                        ))}
                        </div>
                    </div>

                    <div className={`p-1.5 rounded border flex items-center justify-between gap-2 h-7 ${settings.pnl_exit_enabled ? (side === 'bull' ? 'bg-emerald-900/20 border-emerald-800' : 'bg-rose-900/20 border-rose-800') : 'bg-gray-750 border-gray-700'}`}>
                    <div className="flex items-center gap-1 text-[9px] font-bold text-gray-300 whitespace-nowrap pl-1">
                        <DollarSign size={10} /> P&L Exit
                    </div>
                    <div className="flex items-center gap-1.5 flex-1">
                        <div className="flex items-center border border-gray-600 rounded bg-gray-800 h-5 px-1.5 flex-1">
                            <span className="text-gray-400 text-[8px] font-bold mr-1 flex-shrink-0">Tgt</span>
                            <input type="number" value={settings.max_profit} disabled={!settings.pnl_exit_enabled} onChange={(e) => setSettings({...settings, max_profit: parseFloat(e.target.value)})} className="bg-transparent w-full text-[13px] font-bold text-green-400 focus:outline-none min-w-0" />
                        </div>
                        <div className="flex items-center border border-gray-600 rounded bg-gray-800 h-5 px-1.5 flex-1">
                            <span className="text-gray-400 text-[8px] font-bold mr-1 flex-shrink-0">Loss</span>
                            <input type="number" value={settings.max_loss} disabled={!settings.pnl_exit_enabled} onChange={(e) => setSettings({...settings, max_loss: parseFloat(e.target.value)})} className="bg-transparent w-full text-[13px] font-bold text-red-400 focus:outline-none min-w-0" />
                        </div>
                    </div>
                    <div className="flex items-center pr-1">
                        <button onClick={() => setSettings({...settings, pnl_exit_enabled: !settings.pnl_exit_enabled})} className={`w-5 h-2.5 rounded-full flex items-center transition-colors px-0.5 ${settings.pnl_exit_enabled ? (side === 'bull' ? 'bg-emerald-500' : 'bg-rose-500') : 'bg-gray-600'}`}>
                            <div className={`w-1.5 h-1.5 bg-white rounded-full shadow-md transform transition-transform ${settings.pnl_exit_enabled ? 'translate-x-2.5' : 'translate-x-0'}`}></div>
                        </button>
                    </div>
                    </div>
                    <button onClick={() => handleEngineUpdate(side)} className={`w-full mt-2 py-1 rounded text-white text-[10px] font-bold transition-colors uppercase tracking-wide ${side === 'bull' ? 'bg-emerald-700 hover:bg-emerald-600' : 'bg-rose-700 hover:bg-rose-600'}`}>Update</button>
                </div>
                )};

            const OrderTable = ({ orders }) => (
                <div className="bg-gray-800 p-3 rounded-lg shadow-md border border-gray-700 mb-3 min-h-[300px] flex flex-col">
                <div className="flex items-center gap-2 mb-3 border-b border-gray-700 pb-2">
                    <Activity size={16} className="text-gray-400" />
                    <h3 className="font-semibold text-gray-200 text-sm">Executed Orders</h3>
                    <span className="ml-auto bg-gray-700 text-gray-300 text-[10px] px-2 py-0.5 rounded-full border border-gray-600">{orders.length} Orders</span>
                </div>
                <div className="overflow-x-auto flex-1">
                    <table className="w-full text-xs text-left text-gray-300">
                    <thead className="bg-gray-900 text-gray-400 font-medium uppercase">
                        <tr>
                        <th className="px-2 py-2">Stock</th>
                        <th className="px-2 py-2">Entry</th>
                        <th className="px-2 py-2">Tgt/SL</th>
                        <th className="px-2 py-2">P&L</th>
                        <th className="px-2 py-2 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-700">
                        {orders.map(order => {
                        const isBlocked = blacklistedStocks.has(order.symbol);
                        return (
                        <tr key={order.id} className={`hover:bg-gray-750 transition-colors ${isBlocked ? 'opacity-50' : ''}`}>
                            <td className="px-2 py-3">
                            <div className={`font-bold text-sm ${isBlocked ? 'line-through text-red-400' : 'text-gray-100'}`}>
                                {order.symbol} 
                                {order.trade_count > 1 && <span className="ml-1 text-[9px] bg-gray-700 px-1 rounded text-gray-300">#{order.trade_count}</span>}
                            </div>
                            <button onClick={() => openChart(order.symbol)} className="text-[10px] text-blue-400 hover:text-blue-300 flex items-center gap-0.5 mt-0.5">Chart <ExternalLink size={8} /></button>
                            </td>
                            <td className="px-2 py-3 font-mono text-gray-300">{order.entry}</td>
                            <td className="px-2 py-3"><div className="text-green-400 font-medium">{order.target}</div><div className="text-red-400 font-medium">{order.sl}</div></td>
                            <td className="px-2 py-3"><span className={`font-mono font-bold ${order.pnl >= 0 ? 'text-green-400' : 'text-red-400'}`}>{order.pnl > 0 ? '+' : ''}{order.pnl}</span><div className={`mt-0.5 text-[9px] uppercase font-bold tracking-wider ${order.status === 'OPEN' ? 'text-blue-300' : 'text-gray-500'}`}>{order.status}</div></td>
                            <td className="px-2 py-3 text-right">
                            <div className="flex justify-end gap-2">
                                <button onClick={() => toggleStopStock(order.symbol)} className={`p-1.5 rounded border transition-colors ${isBlocked ? 'bg-red-900/20 border-red-800 text-red-500' : 'bg-gray-700 border-gray-600 text-gray-400'}`}><Ban size={12} /></button>
                                {order.status === 'OPEN' && (<button className="bg-red-900/80 text-red-100 hover:bg-red-700 transition-colors px-2 py-1 rounded border border-red-700 text-[10px] font-bold uppercase" onClick={() => panicExit('single')}>Exit</button>)}
                            </div>
                            </td>
                        </tr>
                        )})}
                    </tbody>
                    </table>
                </div>
                </div>
            );

            const ScannerList = ({ scannerData }) => (
                <div className="bg-gray-800 p-3 rounded-lg shadow-md border border-gray-700 mb-3 min-h-[300px] flex flex-col">
                <div className="flex items-center gap-2 mb-3 border-b border-gray-700 pb-2">
                    <Target size={16} className="text-gray-400" />
                    <h3 className="font-semibold text-gray-200 text-sm">Scanner (1 Min Breakout)</h3>
                    <span className="ml-auto bg-gray-700 text-gray-300 text-[10px] px-2 py-0.5 rounded-full border border-gray-600">{scannerData.length}</span>
                </div>
                <div className="space-y-1 flex-1 overflow-y-auto">
                    {scannerData.map((item) => {
                    const isBlocked = blacklistedStocks.has(item.symbol);
                    return (
                    <div key={item.id} className={`flex items-center gap-2 p-2 rounded bg-gray-750 border border-gray-700 transition-all ${isBlocked ? 'opacity-50 grayscale' : 'hover:border-blue-500/50 hover:bg-gray-700'}`}>
                        <div className={`font-bold text-xs w-20 flex items-center gap-1 ${isBlocked ? 'line-through text-gray-500' : 'text-gray-200'}`}>{item.symbol}<button onClick={() => openChart(item.symbol)} className="text-gray-500 hover:text-blue-400"><ExternalLink size={10} /></button></div>
                        <div className="text-[10px] text-gray-400 font-mono w-16">{item.time}</div>
                        <div className={`text-[10px] font-bold uppercase w-16 truncate ${item.signal_strength.includes('Breakout') ? 'text-green-400' : 'text-red-400'}`}>{item.signal_strength}</div>
                        <div className="flex items-center gap-1 text-[10px]"><span className="text-gray-500">VP:</span><span className="font-extrabold text-amber-300">{item.volume_price}</span></div>
                        <div className="flex items-center gap-1 text-[10px]"><span className="text-gray-500">Sz:</span><span className="font-extrabold text-cyan-300">{item.candle_size}</span></div>
                        <div className="ml-auto font-mono font-bold text-gray-300 text-xs">₹{item.price}</div>
                        <button onClick={() => toggleStopStock(item.symbol)} className={`p-1 rounded-full flex-shrink-0 transition-colors ml-2 ${isBlocked ? 'text-red-500 bg-red-900/20' : 'text-gray-500 hover:text-red-400 hover:bg-gray-600'}`}><Ban size={14} /></button>
                    </div>
                    )})}
                </div>
                </div>
            );

            // --- RENDER ---
            return (
                <div className="min-h-screen bg-gray-950 font-sans flex flex-col text-gray-100">
                {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
                
                <header className="bg-gray-900 border-b border-gray-800 px-3 py-1 shadow-lg flex justify-between items-center sticky top-0 z-30 h-10">
                    <div className="flex items-center gap-2">
                        <div className="w-5 h-5 bg-blue-700 rounded flex items-center justify-center font-bold text-[9px] text-white shadow-lg">KM</div>
                        <h1 className="text-xl font-bold tracking-tight text-gray-100 leading-none">Kite <span className="text-blue-500 font-light">Master</span></h1>
                    </div>
                    <div className="flex items-center gap-4 ml-auto">
                        <div className="text-[10px] font-bold uppercase tracking-wider flex items-center gap-2 bg-gray-800 px-2 py-0.5 rounded border border-gray-700">
                            <span className="text-gray-400">Total P&L:</span>
                            <span className={`text-sm ${totalGlobalPnL >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>{totalGlobalPnL > 0 ? '+' : ''}{totalGlobalPnL}</span>
                        </div>
                        <div className={`flex items-center gap-2 px-3 py-0.5 rounded border ${sentiment.isBullish ? 'bg-emerald-950/20 border-emerald-500/20' : 'bg-rose-950/20 border-rose-500/20'}`}>
                            <div className="flex items-center gap-1"><BarChart2 size={14} className={sentiment.isBullish ? 'text-emerald-400' : 'text-rose-400'} /><span className={`text-sm font-black tracking-tight ${sentiment.isBullish ? 'text-emerald-400' : 'text-rose-400'}`}>{sentiment.percentage > 0 ? '+' : ''}{sentiment.percentage}%</span></div>
                            <div className="h-4 w-px bg-gray-700"></div>
                            <div className="text-[10px] font-mono font-bold text-gray-400 flex gap-2"><span>BULL: <span className="text-emerald-400">{sentiment.bullCount}</span></span><span>BEAR: <span className="text-rose-400">{sentiment.bearCount}</span></span></div>
                        </div>
                        <div className="flex items-center gap-3 text-[9px]">
                            {/* CREDENTIALS BUTTON */}
                            <button onClick={() => setIsCredentialsOpen(true)} className="text-gray-400 hover:text-blue-400 transition-colors p-1 rounded hover:bg-gray-800" title="API Credentials"><Key size={14} /></button>
                            
                            <button onClick={() => setIsGlobalSettingsOpen(true)} className="text-gray-400 hover:text-blue-400 transition-colors p-1 rounded hover:bg-gray-800" title="Global Settings"><Settings size={14} /></button>
                            <span className={`flex items-center gap-1 font-medium px-1.5 py-0.5 rounded border ${isConnected ? 'text-emerald-400 bg-emerald-900/20 border-emerald-900/50' : 'text-red-400 bg-red-900/20 border-red-900/50'}`}>
                                <div className={`w-1 h-1 rounded-full ${isConnected ? 'bg-emerald-500' : 'bg-red-500'} animate-pulse`}></div> {isConnected ? 'System Ready' : 'API Missing'}
                            </span>
                            <span className="text-gray-400 border-l border-gray-700 pl-2 hidden md:inline">Master Super User</span>
                        </div>
                    </div>
                </header>
                
                {/* CREDENTIALS MODAL */}
                {isCredentialsOpen && (
                    <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 backdrop-blur-sm">
                    <div className="bg-gray-800 border border-gray-700 rounded-lg shadow-2xl w-96 p-5">
                        <div className="flex justify-between items-center mb-4 border-b border-gray-700 pb-3">
                        <h3 className="text-sm font-bold text-gray-200 flex items-center gap-2"><Key size={16} /> API Credentials</h3>
                        <button onClick={() => setIsCredentialsOpen(false)} className="text-gray-400 hover:text-white transition-colors"><X size={18} /></button>
                        </div>
                        <div className="space-y-4">
                        {isAuthPending && <div className="bg-red-900/30 border border-red-500/50 text-red-200 text-xs p-2 rounded flex items-center gap-2"><ShieldAlert size={14}/> Authentication Required</div>}
                        <div>
                            <label className="block text-gray-400 text-xs font-bold mb-1">API Key</label>
                            <input type="text" className="w-full bg-gray-900 border border-gray-600 rounded p-2 text-xs text-gray-200 focus:border-blue-500 outline-none" value={credentials.apiKey} onChange={(e) => setCredentials({...credentials, apiKey: e.target.value})} placeholder="Enter Kite API Key" />
                        </div>
                        <div>
                            <label className="block text-gray-400 text-xs font-bold mb-1">API Secret</label>
                            <input type="password" className="w-full bg-gray-900 border border-gray-600 rounded p-2 text-xs text-gray-200 focus:border-blue-500 outline-none" value={credentials.apiSecret} onChange={(e) => setCredentials({...credentials, apiSecret: e.target.value})} placeholder="Enter Secret" />
                        </div>
                        
                        <div className="flex gap-2 pt-2">
                            <button onClick={saveCredentials} className="flex-1 bg-gray-700 hover:bg-gray-600 text-white text-xs font-bold py-2 rounded transition-colors">Save Details</button>
                            <button onClick={initiateKiteLogin} className="flex-1 bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold py-2 rounded transition-colors flex items-center justify-center gap-1"><Power size={12} /> Login to Kite</button>
                        </div>
                        
                        {isConnected && <div className="text-center text-[10px] text-emerald-500 flex items-center justify-center gap-1 mt-2"><CheckCircle size={10} /> Keys Configured</div>}
                        </div>
                    </div>
                    </div>
                )}

                {/* GLOBAL SETTINGS MODAL */}
                {isGlobalSettingsOpen && (
                    <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 backdrop-blur-sm">
                    <div className="bg-gray-800 border border-gray-700 rounded-lg shadow-2xl w-96 p-5">
                        <div className="flex justify-between items-center mb-4 border-b border-gray-700 pb-3">
                        <h3 className="text-sm font-bold text-gray-200 flex items-center gap-2"><Settings size={16} /> Global Volume SMA Criteria</h3>
                        <button onClick={() => setIsGlobalSettingsOpen(false)} className="text-gray-400 hover:text-white transition-colors"><X size={18} /></button>
                        </div>
                        <div className="space-y-4">
                        <div className="bg-blue-900/20 border border-blue-800/50 rounded p-2 text-xs text-blue-300 flex items-start gap-2"><Info size={14} className="mt-0.5 flex-shrink-0" /><span>Engines pass if <strong>ANY</strong> of the 3 criteria levels below are met.</span></div>
                        <div className="grid grid-cols-3 gap-2 text-xs font-bold text-gray-400 uppercase tracking-wider mb-1"><div className="pl-1">Level</div><div>Min Vol Price (Cr)</div><div>SMA Multiplier</div></div>
                        {globalSettings.volume_criteria.map((criteria, index) => (
                            <div key={criteria.id} className="grid grid-cols-3 gap-2 items-center bg-gray-900/50 p-2 rounded border border-gray-700">
                                <div className="text-sm font-bold text-gray-300 pl-1">Level {criteria.id}</div>
                                <input type="number" value={criteria.min_vol_price_cr} onChange={(e) => updateGlobalSetting(index, 'min_vol_price_cr', e.target.value)} className="bg-gray-800 border border-gray-600 rounded px-2 py-1 text-sm text-center text-amber-400 font-mono font-bold focus:border-blue-500 outline-none" />
                                <div className="flex items-center"><span className="text-gray-500 mr-1 text-xs">x</span><input type="number" value={criteria.sma_multiplier} onChange={(e) => updateGlobalSetting(index, 'sma_multiplier', e.target.value)} className="bg-gray-800 border border-gray-600 rounded px-2 py-1 text-sm text-center text-cyan-400 font-mono font-bold focus:border-blue-500 outline-none w-full" /></div>
                            </div>
                        ))}
                        <div className="pt-2"><button onClick={saveGlobalCriteria} className="w-full bg-emerald-600 hover:bg-emerald-700 text-white text-xs font-bold py-2.5 rounded transition-colors uppercase tracking-wider shadow-lg">Save Global Criteria</button></div>
                        </div>
                    </div>
                    </div>
                )}

                <main className="p-4 grid grid-cols-2 gap-4 flex-1 items-start">
                    <section className="flex flex-col bg-gray-900 p-3 rounded-xl border-t-4 border-emerald-600 shadow-xl min-h-full">
                    <div className="flex items-center gap-2 mb-2 text-emerald-100 bg-emerald-900/20 p-1.5 rounded-lg border border-emerald-800/30">
                        <TrendingUp size={14} className="text-emerald-400" />
                        <h2 className="text-[9px] font-bold uppercase tracking-wider flex-1 flex items-center gap-2">BULL P&L: <span className={`text-sm ${pnlData.bull >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>{pnlData.bull > 0 ? '+' : ''}{pnlData.bull}</span></h2>
                        <button className="bg-red-600 hover:bg-red-700 text-white text-[10px] font-bold uppercase px-1.5 py-1 rounded flex items-center gap-1 shadow-md border border-red-500 transition-transform active:scale-95" onClick={() => panicExit('bull')}><ShieldAlert size={12} /> EXIT ALL</button>
                    </div>
                    <EngineSettings settings={bullSettings} setSettings={setBullSettings} side="bull" />
                    <OrderTable orders={bullOrders} />
                    <ScannerList scannerData={bullScanner} />
                    </section>

                    <section className="flex flex-col bg-gray-900 p-3 rounded-xl border-t-4 border-rose-600 shadow-xl min-h-full">
                        <div className="flex items-center gap-2 mb-2 text-rose-100 bg-rose-900/20 p-1.5 rounded-lg border border-rose-800/30">
                        <TrendingDown size={14} className="text-rose-400" />
                        <h2 className="text-[9px] font-bold uppercase tracking-wider flex-1 flex items-center gap-2">BEAR P&L: <span className={`text-sm ${pnlData.bear >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>{pnlData.bear > 0 ? '+' : ''}{pnlData.bear}</span></h2>
                        <button className="bg-red-600 hover:bg-red-700 text-white text-[10px] font-bold uppercase px-1.5 py-1 rounded flex items-center gap-1 shadow-md border border-red-500 transition-transform active:scale-95" onClick={() => panicExit('bear')}><ShieldAlert size={12} /> EXIT ALL</button>
                    </div>
                    <EngineSettings settings={bearSettings} setSettings={setBearSettings} side="bear" />
                    <OrderTable orders={bearOrders} />
                    <ScannerList scannerData={bearScanner} />
                    </section>
                </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<Dashboard />);
    </script>
</body>
</html>