<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KiteMaster Algo Dashboard</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <style>
        html, body {
            background-color: #030712 !important;
            color: #f3f4f6;
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0; padding: 0; height: 100%;
        }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1f2937; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
        
        .hidden { display: none !important; }
        .glass-panel {
            background: rgba(17, 24, 39, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(75, 85, 99, 0.3);
        }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="min-h-screen flex flex-col text-gray-100 bg-gray-950">

    <!-- HEADER -->
    <header class="bg-gray-900 border-b border-gray-800 px-3 py-1 shadow-lg flex justify-between items-center sticky top-0 z-30 h-12 w-full">
        <div class="flex items-center gap-2">
           <div class="w-6 h-6 bg-blue-700 rounded flex items-center justify-center font-bold text-[10px] text-white">KM</div>
           <h1 class="text-xl font-bold tracking-tight text-gray-100 leading-none">Kite <span class="text-blue-500 font-light">Master</span></h1>
        </div>
        
        <div class="flex items-center gap-4 ml-auto">
            <!-- Sentiment -->
            <div class="flex items-center gap-2 px-3 py-1 rounded border border-gray-700 bg-gray-900/50">
                <i data-lucide="bar-chart-2" class="w-3 h-3 text-emerald-400"></i>
                <span class="text-sm font-black tracking-tight text-emerald-400" id="sentiment-pct">0%</span>
                <div class="h-4 w-px bg-gray-700 mx-2"></div>
                <div class="text-[10px] font-mono font-bold text-gray-400 flex gap-2">
                    <span>BULL: <span class="text-emerald-400" id="sentiment-bull-count">0</span></span>
                    <span>BEAR: <span class="text-rose-400" id="sentiment-bear-count">0</span></span>
                </div>
            </div>

            <!-- PNL -->
            <div class="text-[10px] font-bold uppercase tracking-wider flex items-center gap-2 bg-gray-800 px-3 py-1 rounded border border-gray-700">
                <span class="text-gray-400">Total P&L:</span>
                <span id="total-pnl" class="text-sm font-black">₹ 0.00</span>
            </div>

            <!-- Heartbeat -->
            <div class="flex items-center gap-2 px-3 py-1 bg-gray-800 rounded border border-gray-700">
                <div id="data-dot" class="w-2 h-2 rounded-full bg-red-500"></div>
                <span id="data-text" class="text-[9px] font-bold uppercase text-red-400 tracking-widest">Disconnected</span>
            </div>
            
            <button onclick="openApiModal()" class="bg-gray-800 hover:bg-gray-700 px-3 py-1.5 rounded border border-gray-600 font-bold uppercase text-[9px]">
               <i data-lucide="key" class="w-3 h-3 inline mr-1 text-blue-400"></i> API Creds
            </button>
        </div>
    </header>

    <!-- SETTINGS MODAL -->
    <div id="settings-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 backdrop-blur-sm hidden">
        <div class="bg-gray-800 border border-gray-700 rounded-lg shadow-2xl w-[44rem] p-5 max-h-[90vh] flex flex-col" id="modal-container">
            <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-3 flex-shrink-0">
                <h3 id="modal-title" class="text-sm font-bold flex items-center gap-2 uppercase tracking-widest">
                    <i data-lucide="settings" class="w-4 h-4 text-emerald-400"></i> Configuration
                </h3>
                <button onclick="closeSettings()" class="text-gray-400 hover:text-white transition-colors"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>
            
            <div class="flex-1 overflow-y-auto pr-2 custom-scrollbar">
                <!-- Parameters -->
                <div class="bg-gray-900/40 p-4 rounded-lg border border-gray-700 mb-4">
                    <div class="grid grid-cols-5 gap-3">
                        <div><label class="block text-[9px] font-bold text-gray-500 uppercase mb-1">R:R</label><input id="inp-rr" class="w-full bg-gray-800 border border-gray-700 rounded px-2 h-8 text-xs font-bold"></div>
                        <div><label class="block text-[9px] font-bold text-gray-500 uppercase mb-1">TSL</label><input id="inp-tsl" class="w-full bg-gray-800 border border-gray-700 rounded px-2 h-8 text-xs font-bold"></div>
                        <div><label class="block text-[9px] font-bold text-gray-500 uppercase mb-1">Max Trades</label><input id="inp-max-trades" type="number" class="w-full bg-gray-800 border border-gray-700 rounded px-2 h-8 text-xs font-bold"></div>
                        <div><label class="block text-[9px] font-bold text-gray-500 uppercase mb-1">Start</label><input id="inp-start" type="time" class="w-full bg-gray-800 border border-gray-700 rounded px-2 h-8 text-[10px]"></div>
                        <div><label class="block text-[9px] font-bold text-gray-500 uppercase mb-1">End</label><input id="inp-end" type="time" class="w-full bg-gray-800 border border-gray-700 rounded px-2 h-8 text-[10px]"></div>
                    </div>

                    <div id="row-mom-sl" class="grid grid-cols-2 gap-3 mt-4 hidden">
                        <div><label class="block text-[9px] font-bold text-rose-400 uppercase mb-1">Stop Loss %</label><input id="inp-sl-pct" type="number" step="0.1" class="w-full bg-gray-800 border border-rose-900/30 rounded h-8 px-2 text-xs text-rose-100"></div>
                        <div><label class="block text-[9px] font-bold text-blue-400 uppercase mb-1">Risk Flat (₹)</label><input id="inp-risk-flat" type="number" class="w-full bg-gray-800 border border-blue-900/30 rounded h-8 px-2 text-xs text-blue-100"></div>
                    </div>

                    <div id="row-cash-risk" class="grid grid-cols-4 gap-3 mt-4">
                        <div><label class="block text-[9px] font-bold text-cyan-400 uppercase mb-1">Max/Stock</label><input id="inp-tps" type="number" class="w-full bg-gray-800 border border-cyan-900/30 rounded h-8 px-2 text-xs"></div>
                        <div><label class="block text-[9px] font-bold text-gray-500 mb-1">Risk(1st)</label><input id="inp-r1" type="number" class="w-full bg-gray-800 border border-gray-700 rounded h-8 px-2 text-xs"></div>
                        <div><label class="block text-[9px] font-bold text-gray-500 mb-1">Risk(2nd)</label><input id="inp-r2" type="number" class="w-full bg-gray-800 border border-gray-700 rounded h-8 px-2 text-xs"></div>
                        <div><label class="block text-[9px] font-bold text-gray-500 mb-1">Risk(3rd)</label><input id="inp-r3" type="number" class="w-full bg-gray-800 border border-gray-700 rounded h-8 px-2 text-xs"></div>
                    </div>
                </div>

                <!-- Matrix Section -->
                <div class="flex items-center gap-2 mb-3 mt-6 border-b border-gray-800 pb-2">
                    <i data-lucide="sliders" class="w-3 h-3 text-emerald-400"></i>
                    <h3 class="font-bold text-gray-200 text-xs uppercase tracking-widest">Volume SMA Matrix (10 Levels)</h3>
                </div>
                <div id="volume-levels-container" class="grid grid-cols-1 gap-2">
                    <!-- Dynamic Matrix Rows will be injected here -->
                </div>
            </div>

            <div class="pt-4 mt-2 border-t border-gray-700">
                <button onclick="saveSettings()" id="btn-save-settings" class="w-full text-white text-xs font-black py-3 rounded uppercase tracking-widest bg-emerald-600 hover:bg-emerald-700 shadow-xl transition-all">
                    Apply Sync to RAM
                </button>
            </div>
        </div>
    </div>

    <!-- MAIN ENGINE GRID -->
    <main class="p-4 grid grid-cols-1 md:grid-cols-2 gap-4 flex-1 overflow-y-auto custom-scrollbar">
        <div id="left-column" class="space-y-4"></div>
        <div id="right-column" class="space-y-4"></div>
    </main>

    <script>
        // Init Lucide
        lucide.createIcons();

        let activeEngine = null;
        let engineStatus = { bull: false, bear: false, mom_bull: false, mom_bear: false };

        // Generate Engine Cards Dynamically to ensure consistency
        const engConfigs = [
            { id: 'bull', name: 'Cash Bull', color: 'emerald', col: 'left' },
            { id: 'mom_bull', name: 'Mom Bull', color: 'blue', col: 'left' },
            { id: 'bear', name: 'Cash Bear', color: 'rose', col: 'right' },
            { id: 'mom_bear', name: 'Mom Bear', color: 'orange', col: 'right' }
        ];

        engConfigs.forEach(eng => {
            const html = `
                <section class="glass-panel p-3 rounded-xl border-t-4 border-${eng.color}-600 shadow-2xl">
                    <div class="flex items-center gap-2 mb-3 bg-${eng.color}-900/10 p-2 rounded-lg border border-${eng.color}-800/30">
                        <i data-lucide="${eng.id.includes('mom') ? 'zap' : 'trending-up'}" class="w-4 h-4 text-${eng.color}-400"></i>
                        <span class="text-[10px] font-black tracking-widest uppercase">${eng.name}</span>
                        <h2 class="text-[10px] font-bold flex-1 flex justify-end items-center gap-2">
                            MTM: <span id="${eng.id}-pnl" class="text-sm font-black text-${eng.color}-400">0.00</span>
                        </h2>
                        <button onclick="toggleEngine('${eng.id}')" id="btn-${eng.id}-toggle" class="w-9 h-5 rounded-full flex items-center bg-gray-700 px-1 ml-3 transition-all">
                            <div id="dot-${eng.id}-toggle" class="w-3.5 h-3.5 bg-white rounded-full shadow-lg transform transition-transform"></div>
                        </button>
                        <button onclick="openSettings('${eng.id}')" class="bg-gray-800 hover:bg-gray-700 text-[9px] font-black uppercase px-2 py-1.5 rounded border border-gray-600 ml-1">Config</button>
                        <button onclick="panicExit('${eng.id}')" class="bg-red-600/80 hover:bg-red-700 text-white text-[9px] font-black uppercase px-2 py-1.5 rounded border border-red-500 ml-1">EXIT</button>
                    </div>
                    <div class="bg-gray-900/50 p-2 rounded-lg border border-gray-800/50 mb-3 min-h-[160px]">
                        <div class="flex justify-between text-[10px] text-gray-500 mb-2 font-black uppercase tracking-widest"><span>Active Positions</span><span id="${eng.id}-order-count">0</span></div>
                        <table class="w-full text-[10px]"><tbody id="${eng.id}-orders-tbody"></tbody></table>
                    </div>
                    <div class="bg-gray-900/80 p-2 rounded-lg border border-gray-800 min-h-[100px] max-h-[150px] overflow-y-auto custom-scrollbar" id="${eng.id}-scanner-list"></div>
                </section>`;
            document.getElementById(eng.col + '-column').innerHTML += html;
        });

        // --- Core API ---
        async function postAPI(action, payload) {
            try {
                const res = await axios.post('/api/control/', { action, ...payload }, {
                    headers: { 'X-CSRFToken': '{{ csrf_token }}' }
                });
                return res.data;
            } catch (e) { console.error("API Err", e); return {}; }
        }

        async function updateDashboard() {
            try {
                const stats = (await axios.get('/api/stats/')).data;
                
                // Update PNL & Sentiment
                document.getElementById('total-pnl').innerText = `₹ ${stats.pnl.total.toFixed(2)}`;
                document.getElementById('total-pnl').className = `text-sm font-black ${stats.pnl.total >= 0 ? 'text-emerald-400' : 'text-rose-500'}`;
                
                if (stats.sentiment) {
                    document.getElementById('sentiment-pct').innerText = stats.sentiment.pct + '%';
                    document.getElementById('sentiment-bull-count').innerText = stats.sentiment.bull;
                    document.getElementById('sentiment-bear-count').innerText = stats.sentiment.bear;
                }

                // Heartbeat
                const dot = document.getElementById('data-dot');
                const txt = document.getElementById('data-text');
                if(stats.data_connected) {
                    dot.className = "w-2 h-2 rounded-full bg-emerald-500 animate-pulse";
                    txt.innerText = "Data Live"; txt.className = "text-[9px] font-bold uppercase text-emerald-400";
                } else {
                    dot.className = "w-2 h-2 rounded-full bg-red-600";
                    txt.innerText = "Disconnected"; txt.className = "text-[9px] font-bold uppercase text-red-500";
                }

                // Sync Each Engine
                engConfigs.forEach(e => {
                    const pnlEl = document.getElementById(`${e.id}-pnl`);
                    if(pnlEl) pnlEl.innerText = stats.pnl[e.id].toFixed(2);
                    updateToggleVisual(e.id, stats.engine_status[e.id] === "1");
                });

                // Sync Tables
                const orders = (await axios.get('/api/orders/')).data;
                engConfigs.forEach(e => renderOrders(orders[e.id] || [], `${e.id}-orders-tbody`, `${e.id}-order-count`));

            } catch (e) { console.warn("Polling..."); }
        }

        function renderOrders(list, bodyId, countId) {
            const tbody = document.getElementById(bodyId);
            document.getElementById(countId).innerText = list.length;
            if(!tbody) return;
            if(list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-6 text-gray-700 italic">No Active Trades</td></tr>';
                return;
            }
            tbody.innerHTML = list.map(ord => `
                <tr class="border-b border-gray-800/50 hover:bg-gray-800/20 transition-colors">
                    <td class="py-2 font-bold text-gray-200 uppercase">${ord.symbol}</td>
                    <td class="py-2 font-mono text-blue-400">@${ord.entry_price.toFixed(1)}</td>
                    <td class="py-2 text-gray-500">Q:${ord.qty}</td>
                    <td class="py-2 font-mono font-bold ${ord.pnl >= 0 ? 'text-emerald-400' : 'text-rose-500'}">₹${ord.pnl.toFixed(1)}</td>
                    <td class="py-2 text-right"><button onclick="forceExit('${ord.symbol}')" class="bg-gray-800 text-[8px] px-1.5 py-0.5 rounded text-gray-500 uppercase">Exit</button></td>
                </tr>
            `).join('');
        }

        // --- Controls ---
        function toggleEngine(side) {
            const newState = !engineStatus[side];
            updateToggleVisual(side, newState);
            postAPI('toggle_engine', { side, enabled: newState });
        }

        function updateToggleVisual(side, enabled) {
            engineStatus[side] = enabled;
            const dot = document.getElementById(`dot-${side}-toggle`);
            const btn = document.getElementById(`btn-${side}-toggle`);
            if(!dot) return;
            dot.style.transform = enabled ? 'translateX(1rem)' : 'translateX(0)';
            
            const color = side.includes('bull') ? '#10b981' : (side.includes('bear') ? '#e11d48' : '#3b82f6');
            btn.style.backgroundColor = enabled ? color : '#374151';
        }

        function panicExit(side) { if(confirm(`Confirm panic exit for ${side.toUpperCase()}?`)) postAPI('panic_exit', { side }); }
        function forceExit(symbol) { if(confirm(`Close ${symbol} trade?`)) postAPI('manual_exit', { symbol }); }

        // --- Settings Matrix Logic ---
        async function openSettings(side) {
            activeEngine = side;
            const modal = document.getElementById('settings-modal');
            const title = document.getElementById('modal-title');
            
            // Step 1: Render structure immediately
            renderVolumeRows([]); 
            modal.classList.remove('hidden');

            // UI adjustments
            const isMom = side.includes('mom');
            document.getElementById('row-mom-sl').classList.toggle('hidden', !isMom);
            document.getElementById('row-cash-risk').classList.toggle('hidden', isMom);
            
            title.innerText = side.replace('_',' ').toUpperCase() + " Configuration";
            
            // Step 2: Fetch and fill
            try {
                const res = await axios.get(`/api/settings/engine/${side}/`);
                const d = res.data;
                document.getElementById('inp-rr').value = d.risk_reward || '1:2';
                document.getElementById('inp-tsl').value = d.trailing_sl || '1:1.5';
                document.getElementById('inp-max-trades').value = d.total_trades || d.max_trades || 5;
                document.getElementById('inp-start').value = d.start_time || '09:15';
                document.getElementById('inp-end').value = d.end_time || '15:15';
                
                if(isMom) {
                    document.getElementById('inp-sl-pct').value = d.stop_loss_pct || 0.5;
                    document.getElementById('inp-risk-flat').value = d.risk_per_trade || 2000;
                } else {
                    document.getElementById('inp-tps').value = d.trades_per_stock || 2;
                    document.getElementById('inp-r1').value = d.risk_trade_1 || 2000;
                    document.getElementById('inp-r2').value = d.risk_trade_2 || 1500;
                    document.getElementById('inp-r3').value = d.risk_trade_3 || 1000;
                }
                if(d.volume_criteria) renderVolumeRows(d.volume_criteria);
            } catch (e) { console.error("Err loading settings"); }
        }

        function renderVolumeRows(criteria) {
            const container = document.getElementById('volume-levels-container');
            container.innerHTML = ''; // Clear
            for(let i=0; i<10; i++) {
                const c = criteria[i] || { min_vol_price_cr: (i+1)*5, sma_multiplier: 2.0, min_sma_avg: 50000 };
                const div = document.createElement('div');
                div.className = "grid grid-cols-4 items-center gap-2 bg-gray-900/60 p-2 rounded border border-gray-700/50 text-[10px]";
                div.innerHTML = `
                    <div class="font-black text-gray-600">LEVEL ${i+1}</div>
                    <div class="flex flex-col"><span class="text-[7px] text-gray-500 uppercase">Min Cr</span><input type="number" step="0.1" class="vol-inp-vp bg-gray-800 border-none rounded px-1.5 py-1 text-amber-500 font-bold" value="${c.min_vol_price_cr}"></div>
                    <div class="flex flex-col"><span class="text-[7px] text-gray-500 uppercase">SMA Mult</span><input type="number" step="0.1" class="vol-inp-sma bg-gray-800 border-none rounded px-1.5 py-1 text-cyan-400 font-bold" value="${c.sma_multiplier}"></div>
                    <div class="flex flex-col"><span class="text-[7px] text-gray-500 uppercase">Avg Vol</span><input type="number" class="vol-inp-avg bg-gray-800 border-none rounded px-1.5 py-1 text-emerald-500 font-bold" value="${c.min_sma_avg}"></div>
                `;
                container.appendChild(div);
            }
        }

        async function saveSettings() {
            const matrix = [];
            const vps = document.querySelectorAll('.vol-inp-vp');
            const smas = document.querySelectorAll('.vol-inp-sma');
            const avgs = document.querySelectorAll('.vol-inp-avg');
            vps.forEach((el, i) => {
                matrix.push({
                    min_vol_price_cr: parseFloat(el.value),
                    sma_multiplier: parseFloat(smas[i].value),
                    min_sma_avg: parseInt(avgs[i].value)
                });
            });

            const payload = {
                risk_reward: document.getElementById('inp-rr').value,
                trailing_sl: document.getElementById('inp-tsl').value,
                total_trades: document.getElementById('inp-max-trades').value,
                start_time: document.getElementById('inp-start').value,
                end_time: document.getElementById('inp-end').value,
                volume_criteria: matrix
            };

            if(activeEngine.includes('mom')) {
                payload.stop_loss_pct = document.getElementById('inp-sl-pct').value;
                payload.risk_per_trade = document.getElementById('inp-risk-flat').value;
            } else {
                payload.trades_per_stock = document.getElementById('inp-tps').value;
                payload.risk_trade_1 = document.getElementById('inp-r1').value;
                payload.risk_trade_2 = document.getElementById('inp-r2').value;
                payload.risk_trade_3 = document.getElementById('inp-r3').value;
            }

            try {
                await axios.post(`/api/settings/engine/${activeEngine}/`, payload, { headers: { 'X-CSRFToken': '{{ csrf_token }}' } });
                closeSettings();
                alert('Success: Synced with HFT Engines');
            } catch (e) { alert("Save Error"); }
        }

        function closeSettings() { document.getElementById('settings-modal').classList.add('hidden'); }
        function openApiModal() { document.getElementById('api-modal').classList.remove('hidden'); }
        function closeApiModal() { document.getElementById('api-modal').classList.add('hidden'); }
        
        async function saveApiCredentials() {
            await postAPI('save_api', { api_key: document.getElementById('api-key-input').value, api_secret: document.getElementById('api-secret-input').value });
            alert("API Saved!"); closeApiModal();
        }

        setInterval(updateDashboard, 1500);
        window.onload = updateDashboard;
    </script>
</body>
</html>